<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Formulario de Sugerencias</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="estilos.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Barra de Navegación -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="img/imagen7ma.jpg" alt="Logo" width="40" height="40" class="me-2">
          <span>7MA TV</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
            <li class="nav-item"><a class="nav-link" href="comunidad.html">Publicidad 7MA</a></li>
            <li class="nav-item"><a class="nav-link" href="Programacion.html">Programación</a></li>
            <li class="nav-item"><a class="nav-link" href="Noticias.html">Noticias</a></li>
            <li class="nav-item"><a class="nav-link" href="EnVivo.html">En Vivo</a></li>
            <li class="nav-item"><a class="nav-link" href="Contacto.html">Contacto</a></li>
            <li class="nav-item"><a class="nav-link" href="sugerencias.html">Sugerencias</a></li>
            <li class="nav-item" id="login-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a></li>
            <li class="nav-item dropdown" id="user-menu" style="display: none;">
              <a class="nav-link dropdown-toggle" href="#" id="user-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="user-initial-icon"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="user-dropdown">
                <li><a class="dropdown-item" href="cuenta.html">Mi Cuenta</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item" id="logout-button">Cerrar Sesión</button></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  
    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="login-form">
              <div class="mb-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Ingresar</button>
            </form>
            <div class="text-center mt-3">
              <a href="registro.html" class="text-white-50">¿No tienes una cuenta? Regístrate aquí</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  
<!-- contenido principal -->
  <div class="container  py-5">
    <div class="card shadow-lg rounded-4 overflow-hidden">
      <div class="row g-0">
        <!-- LADO IZQUIERDO (Info) -->
        <div class="col-md-4 bg-info text-white p-4 d-flex flex-column justify-content-center">
          <div class="mb-4">
            <h5><i class="bi bi-geo-alt-fill"></i> Dirección</h5>
            <p>Calle Arica #130, Nazca, Perú<br>Lima</p>
          </div>
          <div class="mb-4">
            <h5><i class="bi bi-telephone-fill"></i> Teléfono</h5>
            <p>923486342</p>
          </div>
          <div>
            <h5><i class="bi bi-envelope-fill"></i> Correo de Contacto</h5>
            <p>rodrigojy20@gmail.com</p>
          </div>
        </div>

        <!-- LADO DERECHO (Formulario) -->
        <div class="col-md-8 p-5">
          <h3 class="text-primary mb-3">Sugerencias</h3>
          <p class="text-muted">Coloque sus sugerencias</p>
          <form id="sugerencias-form">
            <div class="mb-3">
              <input type="text" name="nombre" class="form-control" placeholder="Nombre" required disabled>
            </div>
            <div class="mb-3">
              <input type="email" name="email" class="form-control" placeholder="Email (se completa al iniciar sesión)" required readonly disabled>
            </div>
            <div class="mb-3">
              <textarea class="form-control" name="mensaje" rows="5" placeholder="Escriba su sugerencia..." required disabled></textarea>
            </div>
            <button type="submit" class="btn btn-primary px-4" disabled>Enviar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
<!-- Scripts de Firebase y Bootstrap -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="firebase-config.js"></script>
<script src="firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Lógica del Formulario de Sugerencias -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const sugerenciasForm = document.getElementById("sugerencias-form");
    if (!sugerenciasForm) return;

    const nombreInput = sugerenciasForm.querySelector("input[name='nombre']");
    const emailInput = sugerenciasForm.querySelector("input[name='email']");
    const mensajeTextarea = sugerenciasForm.querySelector("textarea[name='mensaje']");
    const submitButton = sugerenciasForm.querySelector("button[type='submit']");
    const formDescription = document.querySelector(".p-5 .text-muted");

    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- FUNCIÓN PARA MOSTRAR NOTIFICACIONES TOAST ---
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        let toastHeaderClass = 'bg-primary'; // default
        if (type === 'success') {
            toastHeaderClass = 'bg-success';
        } else if (type === 'danger') {
            toastHeaderClass = 'bg-danger';
        } else if (type === 'warning') {
            toastHeaderClass = 'bg-warning text-dark';
        }

        const toastHTML = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
              <div class="toast-header ${toastHeaderClass} text-white">
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">
                ${message}
              </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // --- Configuración de EmailJS ---
    (function(){
        emailjs.init('sFgWvRUq_B1fcCWua');
    })();

    auth.onAuthStateChanged(function(user) {
        if (user) {
            formDescription.textContent = "Escribe tu sugerencia. Tu correo se adjuntará automáticamente.";
            emailInput.value = user.email;
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().nombre) {
                    nombreInput.value = doc.data().nombre;
                }
            });
            nombreInput.removeAttribute('disabled');
            mensajeTextarea.removeAttribute('disabled');
            submitButton.removeAttribute('disabled');
        } else {
            formDescription.innerHTML = 'Debes <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal">iniciar sesión</a> para poder enviar sugerencias.';
            nombreInput.disabled = true;
            emailInput.disabled = true;
            mensajeTextarea.disabled = true;
            submitButton.disabled = true;
        }
    });

    sugerenciasForm.addEventListener("submit", function (event) {
        event.preventDefault();
        
        const user = auth.currentUser;
        if (!user) {
            showToast("Por favor, inicie sesión para enviar una sugerencia.", "warning");
            return;
        }

        const nombre = nombreInput.value.trim();
        const mensaje = mensajeTextarea.value.trim();
        
        if (!nombre || !mensaje) {
            showToast("Por favor, complete su nombre y el mensaje de la sugerencia.", "warning");
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';

        db.collection("sugerencias").add({
            nombre: nombre,
            email: user.email,
            mensaje: mensaje,
            userId: user.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then((docRef) => {
            const serviceID = 'service_zql69hu';
            const templateID = 'template_pmo8myb';
            const templateParams = { nombre: nombre, mensaje: mensaje };

            emailjs.send(serviceID, templateID, templateParams)
              .then(function(response) {
                 showToast("¡Gracias por tu sugerencia! La hemos recibido correctamente.", "success");
                 sugerenciasForm.reset();
                 emailInput.value = user.email;
                 nombreInput.value = nombre;
              }, function(error) {
                 showToast("Tu sugerencia FUE GUARDADA, pero ocurrió un error al enviar la notificación por correo.", "danger");
              });
        })
        .catch((error) => {
            showToast("Ocurrió un error al guardar tu sugerencia. Por favor, inténtalo de nuevo.", "danger");
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar';
        });
    });
});
</script>

<!-- Pie de página -->
<footer class="footer text-light pt-5">
  <div class="container">
    <div class="text-center small mt-3 text-newsletter">
      © 2025 7MA TV. Todos los derechos reservados. Developer - Aldair Gonzales
    </div>
  </div>
</footer>

</body>
</html>
